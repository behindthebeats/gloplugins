<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml"
	initialize="init()">
	
	<mx:Script>
		<![CDATA[
		
			private var _filePath:String;
			private var _AVM1Mode:Boolean;
			private var _AVM1Loader:SWFLoader;
			
			/**
		 	* Embed localConnection SWF.
		 	*/
			[Bindable]
			[Embed(source="org/glomaker/plugin/swfloader/assets/localConnection.swf")]	
			public var LC:Class;
			
			/**
		 	* Store local connection.
		 	*/
			protected var AVM_lc:CustomLocalConnection;
			
			protected function init():void
			{
				_AVM1Mode = false;
				_AVM1Loader = new SWFLoader();
				_AVM1Loader.id = "swfLoader";
				_AVM1Loader.source = LC;
				
				AVM_lc = new CustomLocalConnection("AVM1toAVM2");
				AVM_lc.addEventListener(Event.COMPLETE, onAVM1LoaderComplete);
				AVM_lc.addEventListener(CustomLocalConnection.PING, onPing);
				AVM_lc.addEventListener(StatusEvent.STATUS, onStatusError);
				
			}
			
			protected function onSWFLoaderComplete(evt:Event):void
			{
				if(swfLoader.content is AVM1Movie && _AVM1Mode == false)
				{
					//removeChild(swfLoader);
					addChild(_AVM1Loader);
					AVM_lc.send("AVM2toAVM1", "load", "file:///"+_filePath);
					
					_AVM1Mode = true;
					
				}else if(swfLoader.content is AVM1Movie && _AVM1Mode == true)
				{
					AVM_lc.send("AVM2toAVM1", "load", "file:///"+_filePath);
					
				}else if(!swfLoader.content is AVM1Movie)
				{
					
					
					//addChild(swfLoader);
					//removeChild(_AVM1Loader)
					_AVM1Mode = false;;
				}
			}
			
			protected function onAVM1LoaderComplete(evt:Event):void
			{
				trace("GOT TO GET HERE!!!!");
				AVM_lc.send("AVM2toAVM1", "load", "file:///"+_filePath);
			}
			
			protected function onPing(evt:Event):void
			{
				trace("PING");
			}
			
			protected function onStatusError(evt:StatusEvent):void
			{
				trace("Local Connection Status Error: " + evt);
			}
			
			public function play():void
			{
				if(_AVM1Mode)
				{
					 AVM_lc.send("AVM2toAVM1", "play");
				}
				
				if(swfLoader.content is MovieClip)
				{
					(swfLoader.content as MovieClip).stop();
				}
				//var lc:LocalConnection = localConnection();
				//lc.send("AVM2toAVM1", "ping");
				//AVM_lc.send();
			}
			
			public function stop():void
			{
				if(_AVM1Mode)
				{
					trace("STOP");
					AVM_lc.send("AVM2toAVM1", "stop");
				}
				
				if(swfLoader.content is MovieClip)
				{
					(swfLoader.content as MovieClip).stop();
				}
			}
			
			public  function set filePath(path:String):void
			{
				_filePath = path;
				swfLoader.load(path);
			}
			
			public  function get filePath():String
			{
				return _filePath;
			}
			
			
		]]>
	</mx:Script>
	
	<mx:SWFLoader id="swfLoader" width="100%" height="100%"/>
</mx:Canvas>
